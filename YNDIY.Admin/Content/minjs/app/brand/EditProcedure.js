require(["/Content/minjs/config.js"],function(){require(["jquery","pop_window","base","utils","domReady"],function(a,b,c,d,b){function e(){var b=a(".pro_tb tbody");b.empty();for(var c=0;c<j.length;c++){var d=a(k);d.children().eq(0).text(c+1),d.children().eq(1).children().val(j[c].name),d.children().eq(2).children().val(j[c].price),d.children().eq(3).text(j[c].stage).attr("_id",j[c].stage_id).attr("_type",j[c].type),0!=j[c].type&&(d.find(".dele").remove(),d.find("input:eq(0)").attr("disabled","disabled").css({"background-color":"#eee"})),b.append(d)}}function f(){_show_loading(),a.ajax({type:"get",url:"/ERPBrand/getProcdureList",data:{id:l},dataType:"json",success:function(b){_hide_loading(),1==b.code?(j=b.data,e()):a.Message({type:"alert",content:b.message})},error:function(b){_hide_loading(),a.Message({type:"alert",content:"网络异常！"})}})}function g(){j=[],a(".pro_tb tbody tr").each(function(b,c){var d={};a(c).find("td").each(function(b,c){0==b?d.id=a(c).text():1==b?d.name=a(c).children().val():2==b?d.price=a(c).children().val():3==b&&(d.stage=a(c).text(),d.stage_id=a(c).attr("_id"),d.type=a(c).attr("_type"))}),j.push(d)})}function h(){return a(".pro_tb tbody tr").each(function(b,c){j[b].id=a(c).find("td:eq(0)").text().replace(/\s/g,""),j[b].name=a(c).find("input:eq(0)").val().replace(/\s/g,""),j[b].price=a(c).find("input:eq(1)").val().replace(/\s/g,""),j[b].stage_id=a(c).find("td:eq(3)").attr("_id"),j[b].stage=a(c).find("td:eq(3)").text().replace(/\s/g,""),j[b].type=a(c).find("td:eq(3)").attr("_type")}),j}function i(b){if(0==b.length)return!1;for(var c=!0,d=0;d<b.length;d++){if(""==b[d].name){a.Message({type:"alert",content:"第"+(d+1)+"个工序未填写工序名称！"}),c=!1;break}if(!/^(0|[1-9]\d{0,4})(\.\d{1,2})?$/.test(b[d].price)){a.Message({type:"alert",content:"第"+(d+1)+"个工序价格格式错误！"}),c=!1;break}if(""==j[d].stage||"undefined"==typeof j[d].stage_id){a.Message({type:"alert",content:"第"+(d+1)+"个工序还未选择工段！"}),c=!1;break}}return c}c.init();var j,k='<tr>                                                                                                                                                         <td>工序号</td>                                                                                                                            <td><input type="text" placeholder="请输入工序名称" class="_input_area "></td>                                        <td><input type="text" placeholder="请输入工序价格" class="_input_area " onkeyup="this.value = this.value.replace(/[^0-9^.]/g, \'\')" onafterpaste="this.value = this.value.replace(/[^0-9]/g,\'\')"></td>                                        <td>请选择工段</td>                                                                                                                   <td class="_td_15 _over_text">                                                                                                     <a href="javascript:;" class="chose_gd">选择工段</a>                                                 <a href="javascript:;" class="change_pst">调整工序</a>                                             <a href="javascript:;" class="dele">×</a>                                                                         </td>                                                                                                                                                 </tr>',l=window.location.href.split("=")[1];window.location.href;a(document).ready(function(){f(),a(".back").on("click",function(){window.location.href="/ERPBrand/ProductList"}),a(".add_bag").on("click",function(){var a={type:0};j.unshift(a),e()}),a(".pro_tb tbody").on("blur","tr input",function(){g()});var b=null;a(".pro_tb").on("click",".chose_gd",function(){b=a(this).parent().prev(),a(".gd_con").show()}),a("._select_gongduan").bind("click",function(){var c=a(this).parent().find("input[type='radio']:checked");if(0==c.length)return void a.Message({type:"alert",content:"请选择工段"});null==b&&a.Message({type:"alert",content:"请重新打开工段选择窗口！"});var d=c.val(),e=c.parent().next().text().replace(/\s/g,"");b.text(e).attr("_id",d),g(),a(this).prev().click()}),a(".pro_tb").on("click",".change_pst",function(){a(".change_pos").show(),old_pos=a(this).parents("tr").eq(0).children().eq(0).text(),a(".old_pos").text(old_pos),g()}),a(".pro_pos").on("blur",function(){var b=a(this).val(),c=parseInt(a(".old_pos").text());return b==c?(a.Message({type:"alert",content:"调整序号相同！"}),void a(this).val("")):b>j.length?(a.Message({type:"alert",content:"序号超出范围！"}),void a(this).val("")):void 0}),a(".change_pos").on("click",".change_ok",function(){var b=a(".pro_pos").val();if(!b)return a.Message({type:"alert",content:"请输入调整序号！"}),void a(".pro_pos").val("");b-=1;var c=a(".old_pos").text()-1;if(b==c)return a.Message({type:"alert",content:"调整序号相同！"}),void a(".pro_pos").val("");if(b>=j.length)return a.Message({type:"alert",content:"序号超出范围！"}),void a(".pro_pos").val("");var d=j.splice(c,1);j.splice(b,0,d[0]),e(),a(".change_pos").hide()}),a(".pro_tb").on("click",".dele",function(){var b=a(this).parent().parent().index();j.splice(b,1),e()})}),a(".sub_mit").bind("click",function(){_show_loading();var b=h();return i(b)?void a.ajax({type:"post",url:"/ERPBrand/saveProcedure",data:{id:l,processList:d.json2str(j)},dataType:"json",success:function(b){_hide_loading(),1==b.code?window.location.href="/ERPBrand/ProductList":a.Message({type:"alert",content:b.message})},error:function(b){_hide_loading(),a.Message({type:"alert",content:"网络异常！"})}}):void _hide_loading()})})});