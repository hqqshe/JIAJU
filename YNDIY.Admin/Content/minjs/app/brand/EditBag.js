require(["/Content/minjs/config.js"],function(){require(["jquery","pop_window","base","utils","domReady"],function(a,b,c,d,b){function e(){q={},q.id=p,q.packageList=[]}function f(){a.when(c.getResponsData({id:p},"/ERPBrand/getPartsInfo")).done(function(a){j=a.partsList})}function g(){a.when(c.getData({id:p},"/ERPBrand/GetPackageInfo")).done(function(a){q.packageList=a})}function h(){var b=a(".parts_con .parts_tb tbody"),c=a(".parts_con .right_parts_tb tbody");b.empty(),c.empty(),void 0!==k&&null!==k||(k=[]);for(var d=0;d<k.length;d++){var e=a(n);e.children().eq(0).text(d+1),e.children().eq(1).text(k[d].name),1===k.length?(e.find(".up").remove(),e.find(".down").remove()):0===d?e.find(".up").remove():d===k.length-1&&e.find(".down").remove(),c.append(e)}for(var f=0;f<j.length;f++){var g=!1;a:for(var h=0;h<q.packageList.length;h++)if(q.packageList[h].partsList)for(var d=0;d<q.packageList[h].partsList.length;d++)if(j[f].name===q.packageList[h].partsList[d].name){g=!0;break a}if(!g){var e=a(m);e.children().first().text(j[f].name),b.append(e)}}}function i(b){var c=a(".pro_gy_con .pro_tab tbody");if(c.empty(),0!==b.length)for(var d=0;d<b.length;d++){var e=a(o);e.children().eq(0).attr("_id",b[d].id),e.children().eq(1).text(b[d].produce_name),e.children().eq(2).text(b[d].model_name),e.children().eq(3).text(b[d].format).attr("title",b[d].format),e.children().eq(4).text(b[d].color),e.children().eq(5).text(b[d].unit),e.children().eq(6).text(b[d].standard_price),c.append(e)}}c.init();var j,k,l=' <tr>                                                                                                                                                         <td class="_td_15 _over_text"></td>                                                                                        <td></td>                                                                                                                                              <td></td>                                                                                                                                              <td class="_td_15 _over_text">                                                                                                       <a href="javascript:;" class="chosen_part">选择部件</a>                                              <a href="javascript:;" class="gy">关联产品</a>                                                                 <a href="javascript:;" class="dele text_info">×</a>                                                       </td>                                                                                                                                                   </tr>',m='  <tr>                                                                                                                                                       <td></td>                                                                                                                                              <td class="_td_15 _over_text">                                                                                                       <a href="javascript:;" class="chose">选择</a>                                                                 </td>                                                                                                                                                   </tr>',n=' <tr>                                                                                                                                                        <td></td>                                                                                                                                              <td></td>                                                                                                                                              <td class="_td_15 _over_text">                                                                                                       <a href="javascript:;" class="up">上移</a>                                                                           <a href="javascript:;" class="down ">下移</a>                                                                    <a href="javascript:;" class="dele">×</a>                                                                           </td>                                                                                                                                                   </tr>',o=' <tr>                                                                                                                                                         <td><input type="radio" name="pro"></td>                                                                         <td></td>                                                                                                                                              <td></td>                                                                                                                                              <td class="_td_20 _over_text"></td>                                                                                                                                              <td></td>                                                                                                                                              <td></td>                                                                                                                                              <td></td>                                                                                                                                          </tr>',p=window.location.search.split("=")[1],q={},r=0;f(),e(),g(),a(".add_bag").on("click",function(){var b=a(".bag_tab tbody"),c=a(l);a(".bag_tab tbody").append(c);var d=b.children().length;b.children().each(function(b,c){a(c).children().eq(0).text(d+"-"+(b+1));var e=q.packageList[b];e?e.packageNumber=d+"-"+(b+1):(e={},e.packageNumber=d+"-"+(b+1),e.number=0,e.lockNumber=0,q.packageList.push(e)),q.packageList[b].relation_id=0})}),a(".bag_tab").on("click",".dele",function(){var b=a(this);a.Message({type:"confirm",content:"确定删除 "+b.parent().parent().children().first().text()+" 包吗,删除后此包下面的部件也将会删除！",okFun:function(){q.packageList.splice(b.parent().parent().index(),1),b.parent().parent().remove();var c=a(".bag_tab tbody"),d=c.children().length;c.children().each(function(b,c){a(c).children().eq(0).text(d+"-"+(b+1));var e=q.packageList[b];e.packageNumber=d+"-"+(b+1)})}})}),a(".bag_tab").on("click",".chosen_part",function(){r=a(this).parents("tr").eq(0).index(),k=q.packageList[r].partsList,h(),a(".parts_con").fadeIn()}),a(".parts_con .parts_tb tbody").on("click",".chose",function(){for(var b=a(this).parent().prev().text(),c=0;c<j.length;c++)if(j[c].name===b){var d=j[c];break}k.push(d),h()}),a(".parts_con .right_parts_tb tbody").on("click",".dele",function(){for(var b=a(this).parent().parent(),c=b.children().eq(1).text(),d=0;d<k.length;d++)if(c===k[d].name){k.splice(d,1);break}h()}),a(".parts_con .right_parts_tb tbody").on("click",".up",function(){for(var b=a(this).parent().parent(),c=b.children().eq(1).text(),d=0;d<k.length;d++)if(0!==d&&c===k[d].name){var e=k.splice(d,1);k.splice(d-1,0,e[0]);break}h()}),a(".parts_con .right_parts_tb tbody").on("click",".down ",function(){for(var b=a(this).parent().parent(),c=b.children().eq(1).text(),d=0;d<k.length;d++)if(d!==k.length-1&&c===k[d].name){var e=k.splice(d,1);k.splice(d+1,0,e[0]);break}h()}),a(".parts_con").on("click",".sub_mit ",function(){q.packageList[r].partsList=k;for(var b="",c=0;c<k.length;c++)b+=k[c].name+",";a(".bag_tab tbody tr").eq(r).children().eq(1).text("").text(b.substring(0,b.length-1)),a(".parts_con").fadeOut(),""!==b&&(q.packageList[r].relation_id=0,a(".bag_tab tbody tr").eq(r).children().eq(2).text("无"))}),a(".bag_tab").on("click",".gy",function(){return r=a(this).parents("tr").eq(0).index(),q.packageList[r].partsList&&0!==q.packageList[r].partsList.length?void a.Message({type:"alert",content:"此包包含部件,无法再关联产品,请先取消包含部件,保存之后再来关联产品！"}):void a(".pro_gy_con").fadeIn()}),a(".pro_gy_con").on("click",".sub_mit ",function(){var b=a(".pro_tab tbody input[type=radio]:checked").parent(),c=b.attr("_id");if(c){if(c===q.id)return void a.Message({type:"alert",content:"不能关联当前产品！"});var d=b.next().next().text();a(".bag_tab tbody tr").eq(r).children().eq(2).text(d)}else c=0;q.packageList[r].relation_id=c,a(".pro_gy_con").fadeOut()}),a(".pro_gy_con .search_btn").on("click",function(){var b=a(".pro_gy_con .search_input").val();return b?void a.when(c.getData({searchKey:b},"/ERPBrand/GetRelationProducts")).done(function(a){i(a)}):void a.Message({type:"alert",content:"请输入产品型号！"})}),a(".sub_mit_all").on("click",function(){for(var b=0;b<q.packageList.length;b++)if(!q.packageList[b].partsList&&0==q.packageList[b].relation_id)return void a.Message({type:"alert",content:q.packageList[b].packageNumber+" 包没有包含部件,并且无关联产品,请先包含或者关联"});a.when(c.getCodeData({id:q.id,packageList:d.json2str(q.packageList)},"/ERPBrand/saveBag","post")).done(function(){window.location.reload()})})})});