require(["/Content/minjs/config.js"],function(){require(["jquery","pop_window","base","laydate","domReady"],function(a,b,c,b,b){function d(){a.when(c.getData({orderId:e},"/ERPOrder/GetSaleOrderOutHistory")).done(function(b){var c=a(".join_con .out_history tbody");c.empty();for(var d=0;d<b.length;d++){var e=a(f);e.children().eq(0).text(b[d].plan_out_date),e.children().eq(1).text(b[d].out_count),e.children().eq(2).text(b[d].state),c.append(e)}})}c.init(),require(["laydate"],function(){var a={elem:"#start_date",format:"YYYY-MM-DD",max:"2099-06-16 23:59:59",istime:!1,istoday:!0,choose:function(a){b.min=a,b.start=a}},b={elem:"#end_date",format:"YYYY-MM-DD",max:"2099-06-16 23:59:59",istime:!1,istoday:!1,choose:function(b){a.max=b,_load_items(1)}},c={elem:"#out_date",format:"YYYY-MM-DD",max:"2099-06-16 23:59:59",istime:!1,istoday:!1,choose:function(a){}};laydate(a),laydate(b),laydate(c)});var e,f="<tr><td></td><td></td><td></td></tr>";window._load_items=function(b){a.when(c.loadHtmlData({order_status:a("#order_status").val(),yanqi_status:a("#yanqi_status").val(),kucun_status:a("#kucun_status").val(),searchKey:a(".search_input").val(),pageIndex:b,start_data:a("#start_date").val(),end_data:a("#end_date").val()},"/ERPOrder/GetOrderList")).done(function(b){a("._ajax_container").empty().append(b),c.repainWindow()})},_load_items(1),a("._ajax_container").on("click",".join",function(){var b=a(this).parents("tr").eq(0).children();a(".join_con .order_info tbody td").each(function(c,d){if(1===c)a(d).text(b.eq(10).text()-b.eq(11).text()-b.eq(12).text());else if(3===c)a(d).text(b.eq(12).text());else if(2===c)a(d).text(b.eq(11).text());else if(4===c){var e=+b.eq(10).text()-+b.eq(11).text()-+b.eq(12).text(),f=+b.eq(13).find(".link_item ").eq(0).text()+ +b.eq(14).text();e>=f&&a(d).text(f)||a(d).text(e)}else 0===c&&a(d).text(b.eq(10).text())}),e=a(this).attr("_id"),d(),a(".join_con").fadeIn().find("input").val("")}),a(".join_con").on("click",".sub_mit",function(){var b=parseInt(a(".join_con input").eq(0).val());if(!b)return void a.Message({type:"alert",content:"请输入本次出库数量！"});var d=a(".join_con .order_info tbody td").eq(4).text();if(b>d)return void a.Message({type:"alert",content:"本次出库数量不能超过可出库数量"});var f=a(".join_con input").eq(1).val();if(!f)return void a.Message({type:"alert",content:"请选择出库日期！"});var g=a(".join_con input").eq(2).val();a.when(c.getCodeData({orderId:e,outCount:b,outDate:f,remarks:g},"/ERPOrder/AddStorageOutPlan")).done(function(){a.Message({type:"alert",content:"提交成功！"}),a(".join_con").fadeOut(),_load_items(1)})}),a("._ajax_container").on("click",".get_store",function(){e=a(this).attr("_id"),pid=a(this).attr("pid"),a.when(c.loadHtmlData({productId:pid,id:e},"/ERPOrder/GetAllocation")).done(function(b){a(".get_store_con ._wraper").empty().append(b),a(".get_store_con").fadeIn()})}),a(".get_store_con").on("click",".sub_mit",function(){var b=a(".sub_num").val(),d="",f="";if(!b&&0===a(".get_store_con tbody tr.plus").length)return void a.Message({type:"alert",content:"请输入库存调拨数量或者选择销售单调拨库存"});if(b>a(".sub_num").parent().prev().text())return void a.Message({type:"alert",content:"库存调拨数量不能大于库存可用数量"});var g=!1;a(".get_store_con tbody tr.plus").each(function(b,c){d+=a(c).attr("_id")+",";var e=a(c).find("input[type='text']").val();return e?void(f+=e+","):(a.Message({type:"alert",content:"请输入订单"+a(c).children().eq(1).text()+" 调拨数量！"}),g=!0,!1)}),g||(d=d.replace(/,$/,""),f=f.replace(/,$/,""),a.when(c.getCodeData({id:e,stockCount:b,saleOrderIds:d,saleOrderCount:f},"/ERPOrder/SetAllocation")).done(function(){a.Message({type:"alert",content:"提交成功！"}),a(".get_store_con").fadeOut(),_load_items(1)}))}),a("._ajax_container").on("click",".dele",function(){var b=a(this),d=b.parents("tr").first().children().eq(0).text();a.Message({type:"confirm",content:"确定删除 "+d+" 销售单？删除后数据不可恢复，请慎重！",okFun:function(){b.attr("_id");a.when(c.getCodeData({order_id:e,outCount:num,outDate:date,remarks:tip},"/ERPOrder/AddStorageOutPlan")).done(function(){a.Message({type:"alert",content:"删除成功！"}),_load_items(1)})}})})})});